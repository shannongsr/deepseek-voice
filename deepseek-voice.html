<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>DeepSeek æµå¼è¯­éŸ³å¯¹è¯ï¼ˆå”¤é†’è¯+æŒç»­ç›‘å¬ä¿®å¤ï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #result { white-space: pre-line; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ¤ ä¸ DeepSeek æµå¼è¯­éŸ³å¯¹è¯</h2>
  <button id="start">å¯åŠ¨ç›‘å¬</button>
  <p id="result">ç­‰å¾…å”¤é†’è¯â€œä½ å¥½â€...</p>

  <script>
    const startBtn = document.getElementById('start');
    const resultText = document.getElementById('result');

    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'zh-CN';
    recognition.continuous = true;
    recognition.interimResults = false;

    let isSpeaking = false;
    let isAwake = false;
    let shouldListen = false; // æ§åˆ¶æ˜¯å¦å…è®¸è‡ªåŠ¨é‡å¯è¯†åˆ«

    startBtn.onclick = () => {
      shouldListen = true;
      recognition.start();
      resultText.innerText = 'ğŸ™ï¸ æ­£åœ¨ç›‘å¬ä¸­... å”¤é†’è¯ï¼šâ€œä½ å¥½â€';
    };

    recognition.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript.trim();
      console.log("è¯†åˆ«åˆ°ï¼š", transcript);
      resultText.innerText = `ä½ è¯´äº†ï¼š${transcript}`;

      // æ›´å¥å£®çš„å”¤é†’è¯è¯†åˆ«
      if (!isAwake && /ä½ \s*å¥½/.test(transcript.toLowerCase())) {
        isAwake = true;
        speakText("ä½ å¥½ï¼Œæˆ‘åœ¨å¬ã€‚è¯·æé—®ã€‚");
        return;
      }

      if (isAwake && !isSpeaking) {
        stopSpeaking();
        resultText.innerText += `\nå‘é€å†…å®¹ï¼š${transcript}\nDeepSeek å›å¤ï¼š`;
        sendStreamToDeepSeek(transcript);
      }
    };

    recognition.onend = () => {
      if (shouldListen) {
        setTimeout(() => {
          try {
            recognition.start();
          } catch (e) {
            console.warn('è‡ªåŠ¨é‡å¯è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œéœ€ç”¨æˆ·æ“ä½œ');
          }
        }, 500);
      }
    };

    async function sendStreamToDeepSeek(text) {
      const response = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer sk-c4490148726f4d04a05da9c4aa8dd0a1'
        },
        body: JSON.stringify({
          model: 'deepseek-chat',
          messages: [{ role: 'user', content: text }],
          temperature: 0.8,
          stream: true
        })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let buffer = '';
      let speechBuffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const lines = buffer.split('\n').filter(line => line.startsWith('data:'));
        for (const line of lines) {
          const jsonStr = line.replace('data: ', '').trim();
          if (jsonStr === '[DONE]') continue;
          try {
            const data = JSON.parse(jsonStr);
            const content = data.choices?.[0]?.delta?.content;
            if (content) {
              resultText.innerText += content;
              speechBuffer += content;
              if (speechBuffer.length >= 10) {
                speakText(speechBuffer);
                speechBuffer = '';
              }
            }
          } catch (err) {
            console.error('è§£æé”™è¯¯ï¼š', err);
          }
        }
        buffer = '';
      }

      if (speechBuffer.length > 0) speakText(speechBuffer);
    }

    function speakText(text) {
      stopSpeaking();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-CN';
      utterance.onstart = () => { isSpeaking = true; };
      utterance.onend = () => { isSpeaking = false; };
      speechSynthesis.speak(utterance);
    }

    function stopSpeaking() {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
      }
    }
  </script>
</body>
</html>
